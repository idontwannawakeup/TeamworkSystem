@page "/team/{TeamId:int}"
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar 
@inject IDialogService DialogService  
@inject ITeamsService TeamsService
@inject IProjectsService ProjectsService
@inject IUsersService UsersService
@inject RequestErrorsHandler RequestErrorsHandler

<MudGrid Spacing="3" Class="mt-8">

    <MudItem xs="12" md="3" Class="d-flex flex-column gap-4">

        <MudPaper Elevation="4" Class="d-flex flex-column align-start gap-2 pa-4">
            @if (team is not null)
            {
                <MudText Typo="@Typo.h6">@team.Name</MudText>
                <MudText Typo="@Typo.subtitle1">@team.Specialization</MudText>
                    <MudButton Variant="@Variant.Outlined"
                               Color="@Color.Tertiary"
                               EndIcon="@Icons.Material.Filled.Add"
                               IconColor="@Color.Inherit"
                               OnClick="@ShowMemberAddingDialog">
                        Add member
                    </MudButton>
                    @if (userId == team.LeaderId)
                    {
                        <MudButton Variant="@Variant.Outlined"
                                   Color="@Color.Info"
                                   EndIcon="@Icons.Material.Filled.Edit"
                                   IconColor="@Color.Inherit"
                                   Link="@EditLink">
                            Edit
                        </MudButton>
                    }
            }
            else
            {
                <MudSkeleton />
                <MudSkeleton />
                <MudSkeleton />
            }
        </MudPaper>

        <MudPaper Elevation="4" Class="pa-4">
            @if (members is not null)
            {
                <MudText Typo="@Typo.h6" Class="py-1">Members</MudText>
                <MudText Typo="@Typo.subtitle1"
                         Style="@colorGrey"
                         Class="pb-1">
                    Total count: @members.Count
                </MudText>
                <MudDivider Class="my-2" />
                <MudList Clickable="@true">
                    @foreach (var member in members)
                    {
                        <MudListItem OnClick="@(e => OpenMemberProfile(member))">
                            <MudElement HtmlTag="div" Class="d-flex align-center gap-3">

                                <MudAvatar Color="@Color.Secondary">A</MudAvatar>

                                <MudElement HtmlTag="div" Class="d-flex flex-column">
                                    <MudText Typo="@Typo.subtitle2">@member.FullName</MudText>
                                    <MudText Typo="@Typo.caption" Style="@colorGrey">@member.Profession</MudText>
                                </MudElement>

                                @if (userId == team.LeaderId)
                                {
                                    <MudMenu Class="ml-auto"
                                             Icon="@Icons.Material.Filled.MoreHoriz"
                                             Dense="@true"
                                             OffsetX="true"
                                             Direction="@Direction.Left">
                                        <MudMenuItem OnClick="@(async e => await DeleteMemberAsync(member))">
                                            Remove
                                        </MudMenuItem>
                                    </MudMenu>
                                }

                            </MudElement>
                        </MudListItem>
                    }
                </MudList>
                @if (ShowMore)
                {
                    <MudButton Variant="@Variant.Outlined"
                               Color="@Color.Tertiary"
                               FullWidth="@true">
                        Show more
                    </MudButton>
                }
            }
            else
            {
                <Loader />
            }
        </MudPaper>

    </MudItem>

    <MudItem xs="12" md="9">
        @if (projects is not null)
        {
            <MudTable T="@ProjectViewModel"
                      Items="@projects"
                      Hover="@true"
                      Elevation="4"
                      OnRowClick="@OnRowClick"
                      RowClass="cursor-pointer">
                <ToolBarContent>
                    <MudText Typo="@Typo.h4">Projects</MudText>
                    <MudToolBarSpacer />
                    @*<MudTextField T="@string"
                                  Adornment="@Adornment.End"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  Variant="@Variant.Text"
                                  Label="Search" />*@
                </ToolBarContent>
                <HeaderContent>
                    <MudTh>Title</MudTh>
                    <MudTh>Type</MudTh>
                    <MudTh>Url</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Title">@context.Title</MudTd>
                    <MudTd DataLabel="Type">
                        @if (context.Type is not null)
                        {
                            @context.Type
                        }
                        else
                        {
                            <NoneChip />
                        }
                    </MudTd>
                    <MudTd DataLabel="Url">
                        @if (!string.IsNullOrWhiteSpace(context.Url))
                        {
                            @context.Url
                        }
                        else
                        {
                            <NoneChip />
                        }
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
        else
        {
            <Loader />
        }
    </MudItem>

</MudGrid>

@code {

    [Parameter] public int TeamId { get; set; }

    [CascadingParameter] private Task<AuthenticationState> State { get; set; }

    private string EditLink => $"/team/{TeamId}/settings";

    private bool ShowMore => members.Count > 10;

    private TeamViewModel team = null;

    private List<ProjectViewModel> projects = null;

    private List<UserViewModel> members = null;

    private string userId = null;

    private string colorGrey = $"color: {Colors.Grey.Default};";

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await InitializeUserIdAsync();
        await InitializeTeamAsync();
        await InitializeProjectsAsync();
        await InitializeMembersAsync();
    }

    private void OnRowClick(TableRowClickEventArgs<ProjectViewModel> args) =>
        NavigationManager.NavigateTo($"/project/{args.Item.Id}/overview");

    private async Task InitializeUserIdAsync() =>
        userId = await ApiAuthenticationStateProvider.GetUserIdFromStateAsync(State);

    private async Task InitializeTeamAsync() =>
        team = await TeamsService.GetByIdAsync(TeamId);

    private async Task InitializeProjectsAsync() =>
        projects = await ProjectsService.GetByTeamIdAsync(TeamId) as List<ProjectViewModel>;

    private async Task InitializeMembersAsync() =>
        members = await UsersService.GetByTeamIdAsync(TeamId) as List<UserViewModel>;

    private async Task DeleteMemberAsync(UserViewModel user)
    {
        var confirmed = await DialogService.ShowDeleteConfirmingDialog(
            "Are you sure you want to remove this member?") ?? false;

        if (confirmed)
        {
            await RequestErrorsHandler.HandleRequestAsync(async () =>
            {
                await TeamsService.DeleteMemberAsync(new() { TeamId = team.Id, UserId = user.Id });
                Snackbar.Add("Member deleted", Severity.Success);
                await InitializeMembersAsync();
            });
        }
    }

    private void ShowMemberAddingDialog()
    {
        DialogService.ShowMemberAddingDialog(TeamId, async () =>
        {
            await InitializeMembersAsync();
            StateHasChanged();
        });
    }

    private void OpenMemberProfile(UserViewModel member)
    {
        if (userId == member.Id)
        {
            NavigationManager.NavigateTo($"/profile");
            return;
        }

        NavigationManager.NavigateTo($"/users/{member.Id}/profile");
    }

}
